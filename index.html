<html>
<head>
<link rel="stylesheet" href="css/style.css"/>
<script src="ext/three.js"></script>
<script src="ext/underscore.js"></script>
<script src="js/TextureMapping.js"></script>
<script src="js/ModelNode.js"></script>
<script src="js/Model.js"></script>
<script src="js/Sounds.js"></script>
<script src="js/Logic.js"></script>
<script src="js/Billboards.js"></script>
<script src="js/Particles.js"></script>
<script src="js/SplineAnimation.js"></script>
<script src="js/Interface.js"></script>
<script src="test.js"></script>
<script id="vertShader" type="shader">
varying vec2 vUv;
varying vec3 vecPos;
varying vec3 vecNormal;

uniform float textRepeatX;
uniform float textRepeatY;
uniform int textureOn;

// https://csantosbh.wordpress.com/2014/01/09/custom-shaders-with-three-js-uniforms-textures-and-lighting/
void main() {
	if (textureOn == 1) {
	    // vUv = uv;
	    vUv = uv * vec2(textRepeatX, textRepeatY);
	    // Since the light is on world coordinates,
	    // I'll need the vertex position in world coords too
	    // (or I could transform the light position to view
	    // coordinates, but that would be more expensive)
	    vecPos = (modelMatrix * vec4(position, 1.0 )).xyz;
	    // That's NOT exacly how you should transform your
	    // normals but this will work fine, since my model
	    // matrix is pretty basic
	    vecNormal = (modelMatrix * vec4(normal, 0.0)).xyz;
	    gl_Position = projectionMatrix *
	                  modelViewMatrix * vec4(position, 1.0 );
    }
}
</script>
<script id="fragShader" type="shader">
precision highp float;
 
varying vec2 vUv;
varying vec3 vecPos;
varying vec3 vecNormal;
 
uniform float color;
uniform sampler2D texture;
uniform int textureOn;
uniform int isBg;
 
// https://github.com/mrdoob/three.js/blob/master/src/renderers/shaders/UniformsLib.js
uniform vec3 ambientLightColor[MAX_POINT_LIGHTS];
uniform vec3 pointLightColor[MAX_POINT_LIGHTS];
uniform vec3 pointLightPosition[MAX_POINT_LIGHTS];
uniform float pointLightDistance[MAX_POINT_LIGHTS];
 
void main(void) {
    // Pretty basic lambertian lighting...
    if (textureOn == 1) {
	    vec4 addedLights = vec4(0.0,0.0,0.0, 1.0);
	    for(int l = 0; l < MAX_POINT_LIGHTS; l++) {
	        vec3 lightDirection = normalize(vecPos
	                              -pointLightPosition[l]);
	        addedLights.rgb += clamp(dot(-lightDirection,
	                                 vecNormal), 0.0, 1.0)
	                           * pointLightColor[l];
	    }
	    for (int l = 0; l < MAX_POINT_LIGHTS; l++) {
	    	addedLights.rgb += ambientLightColor[l];
	    }

	    if (isBg == 1) {
	    	gl_FragColor = texture2D(texture, vUv);
	    }
	    else {
		    gl_FragColor = texture2D(texture, vUv) * addedLights;
		}
	}
}
</script>
</head>
<body style="margin: 0px;" onload="init()">
	<!-- Game sounds -->
	<div style="display: hidden;">
		<audio id="runSound">
			<source type="audio/wav" src="sounds/Meat_feet_fast1.wav"></source>
		</audio>
		<audio id="jumpSound">
			<source type="audio/wav" src="sounds/Meat_jumps0.wav"></source>
		</audio>
		<audio id="landSound">
			<source type="audio/wav" src="sounds/Meat_Landing0.wav"></source>
		</audio>
		<audio id="deathSound">
			<source type="audio/wav" src="sounds/meat_death1.wav"></source>
		</audio>
		<audio id="sawSound">
			<source type="audio/wav" src="sounds/SawDeath0.wav"></source>
		</audio>

		<audio id="backgroundMusic">
			<source type="audio/mpeg" src="sounds/Danny Baranowsky - Super Meat Boy! - Digital Special Edition Soundtrack - 04 Ballad of the Burning Squirrel (Ch 1 Dark World).mp3"></source>
		</audio>
	</div>

	<div id="canvas-container" class="canvasContainer">
		<div id="start-menu" class="hidden">
			Press any key to start <br>
			Space to jump <br>
			"P" to pause <br>
			"R" to restart <br>

			<p>Other: "M" to mute music, "S" to mute sound effects, "T" to toggle textures</p>
		</div>
		<div id="pause-menu" class="hidden">
		</div>
		<div id="black">
		</div>
	</div>
</body>
</html>